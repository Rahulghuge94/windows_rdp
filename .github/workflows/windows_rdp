name: Windows-RDP
on: 
  workflow_dispatch: # Only run manually

jobs:
  dev_tunnel:
    runs-on: windows-latest
    # Set a reasonable timeout for your debugging/development session
    timeout-minutes: 360
    env:
      # Define the path where Cloudflared files will live
      TUNNEL_DIR: C:\cloudflared_files
    steps:
      - name: Set RDP Password for 'runneradmin'
        # The default user on Windows runners is 'runneradmin'
        run: net user runneradmin ${{ secrets.RDP_PASSWORD }}
        shell: powershell

      - name: Enable RDP Service and Firewall
        run: |
          # 1. Enable RDP service
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -name "fDenyTSConnections" -Value 0
          # 2. Allow RDP through the Windows Firewall
          Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
          echo "RDP has been enabled."
        shell: powershell
        
      - name: Download and Install Cloudflared
        # Download the executable and place it in a location accessible by the PATH or directly
        run: |
          Invoke-WebRequest -Uri https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-windows-amd64.exe -OutFile cloudflared.exe
          mkdir -p $env:TUNNEL_DIR
          Move-Item cloudflared.exe $env:TUNNEL_DIR
          echo "Cloudflared installed to $env:TUNNEL_DIR"
        shell: powershell

      - name: Start Cloudflared Tunnel
        # The -f flag keeps the process running, which keeps the GitHub job active.
        run: |
          & "$env:TUNNEL_DIR\cloudflared.exe" service install ${{ secrets.TUNNEL_SECRET }}
        shell: powershell

      - name: ðŸ›‘ Instructions (Will not execute until tunnel stops)
        # This step is mostly for documentation, as the previous step holds the job.
        run: |
          echo "========================================================"
          echo "Tunnel has been stopped or the job was cancelled."
          echo "========================================================"
        shell: bash
