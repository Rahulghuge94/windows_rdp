name: WINDOWS RDP

on:
  workflow_dispatch:

jobs:
  rdp-session:
    # Use a Windows runner for RDP
    runs-on: windows-latest

    env:
      # Define the path where Cloudflared files will live
      TUNNEL_DIR: C:\cloudflared_files
      
    steps:
      - name: üîê Set RDP Password for 'runneradmin'
        # The default user on Windows runners is 'runneradmin'
        run: net user runneradmin ${{ secrets.RDP_PASSWORD }}
        shell: powershell

      - name: üñ•Ô∏è Enable RDP Service and Firewall
        run: |
          # 1. Enable RDP service
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -name "fDenyTSConnections" -Value 0
          # 2. Allow RDP through the Windows Firewall
          Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
          echo "RDP has been enabled."
        shell: powershell
        
      - name: üì• Download and Install Cloudflared
        # Download the executable and place it in a location accessible by the PATH or directly
        run: |
          Invoke-WebRequest -Uri https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-windows-amd64.exe -OutFile cloudflared.exe
          mkdir -p $env:TUNNEL_DIR
          Move-Item cloudflared.exe $env:TUNNEL_DIR
          echo "Cloudflared installed to $env:TUNNEL_DIR"
        shell: powershell
        
      - name: üìù Create Config and Credential Files
        run: |
          # 1. Decode and create the config.yaml file
          [System.Text.Encoding]::UTF8.GetString([System.Convert]::FromBase64String("${{ secrets.CLOUDFLARE_TUNNEL_CONFIG }}")) | Out-File "$env:TUNNEL_DIR\config.yaml"
          
          # 2. Decode and create the tunnel credentials JSON file
          [System.Text.Encoding]::UTF8.GetString([System.Convert]::FromBase64String("${{ secrets.CLOUDFLARE_TUNNEL_CREDENTIAL }}")) | Out-File "$env:TUNNEL_DIR\credentials.json"
          
          echo "Configuration files created in $env:TUNNEL_DIR"
        shell: powershell

      - name: üöÄ Start Cloudflared Tunnel
        # The -f flag keeps the process running, which keeps the GitHub job active.
        run: |
          & "$env:TUNNEL_DIR\cloudflared.exe" service install ${{ secrets.TUNNEL_SECRET }}
        shell: powershell

      - name: üõë Instructions (Will not execute until tunnel stops)
        # This step is mostly for documentation, as the previous step holds the job.
        run: |
          echo "========================================================"
          echo "Tunnel has been stopped or the job was cancelled."
          echo "========================================================"
        shell: bash
