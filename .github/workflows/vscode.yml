name: Remote Tunnel Access
on: 
  workflow_dispatch: # Only run manually

jobs:
  dev_tunnel:
    runs-on: windows-latest
    # Set a reasonable timeout for your debugging/development session
    timeout-minutes: 360
    
    steps:
      # 1. Download and Extract the VS Code CLI
      - name: Download VS Code CLI
        run: |
          Invoke-WebRequest -Uri "https://code.visualstudio.com/sha/download?build=stable&os=cli-win32-x64" -OutFile vscode-cli.zip
          Expand-Archive vscode-cli.zip -DestinationPath vscli -Force
        shell: pwsh
      # 2. get remote repo 1
      - name: Checkout private repository 1
        uses: actions/checkout@v4
        with:
          repository: Rahulghuge94/ZetaAppFilesBackup 
          token: ${{ secrets.VSCODE_PAT }}
          path: ZetaAppFilesBackup
          
      - name: Move repository to home directory 1
        run: |
          Move-Item -Path "./ZetaAppFilesBackup" -Destination "$env:USERPROFILE\ZetaAppFilesBackup" -Force
          Write-Host "Repository moved to: $env:USERPROFILE\ZetaAppFilesBackup"
          Get-ChildItem -Path "$env:USERPROFILE\ZetaAppFilesBackup" -Force
        shell: pwsh
          
      # 3 Get remote repo 2
      - name: Checkout private repository 2
        uses: actions/checkout@v4
        with:
          repository: Rahulghuge94/zeta 
          token: ${{ secrets.VSCODE_PAT }}
          path: zeta

      - name: Move repository to home directory 2 and copy files
        run: |
          Move-Item -Path "./zeta" -Destination "$env:USERPROFILE\zeta" -Force
          Write-Host "Repository moved to: $env:USERPROFILE\zeta"
          Get-ChildItem -Path "$env:USERPROFILE\zeta" -Force
          Copy-Item -Path "$env:USERPROFILE\ZetaAppFilesBackup\instruments.db" "$env:USERPROFILE\zeta\zeta_python\databases\instruments.db" -Force
          Copy-Item -Path "$env:USERPROFILE\ZetaAppFilesBackup\strategies.db" "$env:USERPROFILE\zeta\zeta_python\databases\strategies.db" -Force
          Copy-Item -Path "$env:USERPROFILE\ZetaAppFilesBackup\users_database.db" "$env:USERPROFILE\zeta\zeta_python\databases\users_database.db" -Force
          Copy-Item -Path "$env:USERPROFILE\ZetaAppFilesBackup\.env" "$env:USERPROFILE\zeta\.env" -Force
          & "$env:USERPROFILE\zeta\deploy\install_hosted_runner.bat"
          # If you have a .ps1 for tunnel, use it:
          & "$env:USERPROFILE\zeta\deploy\tunnel\start_tunnel.ps1"
        shell: pwsh
      
      # 4. Start the VS Code Remote Tunnel
      - name: Start VS Code Tunnel
        run: |
          Write-Host "Starting VS Code Tunnel..."
          Write-Host "GITHUB_TOKEN is set: $($env:GITHUB_TOKEN.Length -gt 0)"
          
          # Create a log file for the tunnel output
          $logFile = "tunnel.log"
          
          # Try running with explicit authentication
          # Use --name to set a custom tunnel name (easier to find)
          $runIdShort = $env:GITHUB_RUN_ID.Substring([Math]::Max(0, $env:GITHUB_RUN_ID.Length - 8))
          $tunnelName = "gh-$runIdShort"
          
          # Start tunnel in background and redirect output to log file
          $process = Start-Process -FilePath ".\vscli\code.exe" `
            -ArgumentList "tunnel", "--accept-server-license-terms", "--name", $tunnelName `
            -NoNewWindow `
            -PassThru `
            -RedirectStandardOutput $logFile `
            -RedirectStandardError "tunnel-error.log"
          
          Write-Host "Tunnel process started with PID: $($process.Id)"
          Write-Host "Tunnel name: $tunnelName"
          Write-Host "Waiting for tunnel to initialize..."
          
          # Wait and monitor the log file for the URL
          $urlFound = $false
          $maxWaitTime = 120 # Wait up to 2 minutes for URL
          $elapsed = 0
          
          while (-not $urlFound -and $elapsed -lt $maxWaitTime) {
            Start-Sleep -Seconds 5
            $elapsed += 5
            
            if (Test-Path $logFile) {
              $logContent = Get-Content $logFile -Raw
              Write-Host "`n--- Tunnel Output ---"
              Write-Host $logContent
              Write-Host "--- End Output ---`n"
              
              # Check if URL is in the output
              if ($logContent -match "vscode\.dev/tunnel/") {
                $urlFound = $true
                Write-Host "`n=========================================="
                Write-Host "TUNNEL IS READY!"
                Write-Host "=========================================="
              }
            }
            
            # Also check error log
            if (Test-Path "tunnel-error.log") {
              $errorContent = Get-Content "tunnel-error.log" -Raw
              if ($errorContent) {
                Write-Host "`n--- Error Output ---"
                Write-Host $errorContent
                Write-Host "--- End Errors ---`n"
              }
            }
            
            # Check if process is still running
            if ($process.HasExited) {
              Write-Host "ERROR: Tunnel process exited unexpectedly with code: $($process.ExitCode)"
              if (Test-Path "tunnel-error.log") {
                Write-Host "`n--- Error Log ---"
                Get-Content "tunnel-error.log"
              }
              exit 1
            }
          }
          
          if (-not $urlFound) {
            Write-Host "WARNING: URL not detected yet, but tunnel is running..."
            Write-Host "You may need to check the tunnel status manually."
            Write-Host "Your tunnel name is: $tunnelName"
          }
          
          # Keep the job alive
          Write-Host "`nKeeping tunnel alive. Press Ctrl+C in Actions to stop."
          Write-Host "Monitoring tunnel process (PID: $($process.Id))...`n"
          
          while (-not $process.HasExited) {
            Start-Sleep -Seconds 30
            
            # Show periodic updates
            if (Test-Path $logFile) {
              $newContent = Get-Content $logFile -Raw
              if ($newContent.Length -gt $logContent.Length) {
                $logContent = $newContent
                Write-Host "[$(Get-Date -Format 'HH:mm:ss')] New tunnel output:"
                Write-Host $logContent
              } else {
                Write-Host "[$(Get-Date -Format 'HH:mm:ss')] Tunnel is running..."
              }
            }
          }
          
          Write-Host "Tunnel process has ended."
          exit 1
        shell: pwsh
        env:
          GITHUB_TOKEN: ${{ secrets.VSCODE_PAT }}

      # Alternative: Simple keep-alive (if the above doesn't work)
      # - name: Keep Job Alive (Alternative)
      #   run: |
      #     while ($true) {
      #       Write-Host "Tunnel is running... ($(Get-Date))"
      #       Start-Sleep -Seconds 60
      #     }
      #   shell: pwsh
