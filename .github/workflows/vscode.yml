name: Remote Tunnel Access
on: 
  workflow_dispatch: # Only run manually

jobs:
  dev_tunnel:
    runs-on: windows-latest
    # Set a reasonable timeout for your debugging/development session
    timeout-minutes: 360
    
    steps:
      # 1. Download and Extract the VS Code CLI
      - name: Download VS Code CLI
        run: |
          Invoke-WebRequest -Uri "https://code.visualstudio.com/sha/download?build=stable&os=cli-win32-x64" -OutFile vscode-cli.zip
          Expand-Archive vscode-cli.zip -DestinationPath vscli -Force
        shell: pwsh

      # 2. Start the VS Code Remote Tunnel
      - name: Start VS Code Tunnel
        run: |
          # Start tunnel in background using Start-Job
          $job = Start-Job -ScriptBlock {
            Set-Location $using:PWD
            & ".\vscli\code.exe" tunnel --accept-server-license-terms
          }
          
          # Wait a moment for tunnel to start
          Start-Sleep -Seconds 10
          
          # Keep the job alive by monitoring it
          while ($true) {
            $jobState = (Get-Job -Id $job.Id).State
            if ($jobState -eq "Failed" -or $jobState -eq "Stopped") {
              Write-Host "Tunnel job ended unexpectedly"
              Receive-Job -Id $job.Id
              exit 1
            }
            
            # Output any new job output
            Receive-Job -Id $job.Id
            
            # Wait before checking again
            Start-Sleep -Seconds 30
          }
        shell: pwsh
        env:
          GITHUB_TOKEN: ${{ secrets.VSCODE_PAT }}

      # Alternative: Simple keep-alive (if the above doesn't work)
      # - name: Keep Job Alive (Alternative)
      #   run: |
      #     while ($true) {
      #       Write-Host "Tunnel is running... ($(Get-Date))"
      #       Start-Sleep -Seconds 60
      #     }
      #   shell: pwsh
